# 📊 DIAGRAMA DEL SISTEMA DE CONTROL DE TOKENS Y CONTABILIZACIÓN

## 🏗️ **ARQUITECTURA DEL SISTEMA**

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           🎯 SISTEMA DE CONTABILIZACIÓN                        │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   📧 EMAIL      │    │  💬 WHATSAPP    │    │   📱 SMS        │    │  🔌 API CALLS   │
│   $0.001/email  │    │  $0.005/msg     │    │   $0.01/SMS     │    │  $0.0001/call   │
└─────────┬───────┘    └─────────┬───────┘    └─────────┬───────┘    └─────────┬───────┘
          │                      │                      │                      │
          └──────────────────────┼──────────────────────┼──────────────────────┘
                                 │                      │
                    ┌─────────────▼─────────────┐      │
                    │    📊 USAGE TRACKER       │      │
                    │  - Registra uso           │      │
                    │  - Calcula costos         │      │
                    │  - Verifica límites       │      │
                    └─────────────┬─────────────┘      │
                                 │                      │
                    ┌─────────────▼─────────────┐      │
                    │   🎯 LIMITS CONTROLLER    │      │
                    │  - Controla límites       │      │
                    │  - Genera alertas         │      │
                    │  - Bloquea excesos        │      │
                    └─────────────┬─────────────┘      │
                                 │                      │
                    ┌─────────────▼─────────────┐      │
                    │   💰 BILLING SYSTEM       │      │
                    │  - Genera facturas        │      │
                    │  - Calcula totales        │      │
                    │  - Procesa pagos          │      │
                    └─────────────┬─────────────┘      │
                                 │                      │
                    ┌─────────────▼─────────────┐      │
                    │   📈 REPORTING DASHBOARD  │      │
                    │  - Métricas en tiempo real│      │
                    │  - Reportes detallados    │      │
                    │  - Gráficos de uso        │      │
                    └───────────────────────────┘      │
                                                       │
                    ┌──────────────────────────────────▼──────────────────────────┐
                    │                    🗄️ DATABASE                              │
                    │  - UsageTracking (uso por servicio)                        │
                    │  - UsageLimits (límites por cliente)                       │
                    │  - Billing (facturación y pagos)                           │
                    │  - Alerts (alertas y notificaciones)                       │
                    └─────────────────────────────────────────────────────────────┘
```

## 🔄 **FLUJO DE CONTABILIZACIÓN**

```
1. 📱 CLIENTE ENVÍA REQUEST
   │
   ▼
2. 🔍 VERIFICAR LÍMITES
   │  ┌─ ¿Límite OK? ──→ ✅ CONTINUAR
   │  └─ ¿Límite excedido? ──→ ❌ BLOQUEAR
   │
   ▼
3. 🚀 EJECUTAR SERVICIO
   │  ┌─ Email ──→ 📧 Enviar emails
   │  ├─ WhatsApp ──→ 💬 Enviar mensajes
   │  ├─ SMS ──→ 📱 Enviar SMS
   │  └─ API ──→ 🔌 Procesar llamada
   │
   ▼
4. 📊 REGISTRAR USO
   │  ┌─ Cantidad usada
   │  ├─ Costo calculado
   │  ├─ Metadatos del servicio
   │  └─ Timestamp
   │
   ▼
5. 🎯 ACTUALIZAR CONTADORES
   │  ┌─ Contador mensual
   │  ├─ Contador diario
   │  ├─ Límites restantes
   │  └─ Porcentaje de uso
   │
   ▼
6. 🚨 VERIFICAR ALERTAS
   │  ┌─ 80% ──→ ⚠️ ADVERTENCIA
   │  ├─ 95% ──→ 🚨 ALERTA CRÍTICA
   │  └─ 100% ──→ 🛑 BLOQUEO
   │
   ▼
7. 📈 ACTUALIZAR DASHBOARD
   │  ┌─ Métricas en tiempo real
   │  ├─ Gráficos de uso
   │  ├─ Reportes automáticos
   │  └─ Notificaciones
```

## 💰 **ESTRUCTURA DE COSTOS**

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              💰 MATRIZ DE COSTOS                               │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────┬─────────────┬─────────────┬─────────────┬─────────────┬─────────────┐
│   SERVICIO  │   COSTO     │   LÍMITE    │   COSTO     │   COSTO     │   COSTO     │
│             │  UNITARIO   │   BÁSICO    │   MÁXIMO    │   MÁXIMO    │   MÁXIMO    │
│             │             │             │   BÁSICO    │   PROFES.   │   EMPRES.   │
├─────────────┼─────────────┼─────────────┼─────────────┼─────────────┼─────────────┤
│ 📧 EMAIL    │  $0.001     │  10,000     │   $10.00    │   $50.00    │  $200.00    │
│ 💬 WHATSAPP │  $0.005     │   5,000     │   $25.00    │  $125.00    │  $500.00    │
│ 📱 SMS      │  $0.01      │   2,000     │   $20.00    │  $100.00    │  $500.00    │
│ 🔌 API      │  $0.0001    │ 100,000     │   $10.00    │   $50.00    │  $200.00    │
└─────────────┴─────────────┴─────────────┴─────────────┴─────────────┴─────────────┘

TOTAL MÁXIMO MENSUAL:
┌─────────────┬─────────────┬─────────────┬─────────────┐
│   PLAN      │   COSTO     │   LÍMITE    │   TOTAL     │
│             │   FIJO      │   SERVICIOS │   MÁXIMO    │
├─────────────┼─────────────┼─────────────┼─────────────┤
│ 🟢 BÁSICO   │   $29.00    │   $65.00    │   $94.00    │
│ 🟡 PROFES.  │   $79.00    │  $325.00    │  $404.00    │
│ 🔴 EMPRES.  │  $199.00    │ $1,400.00   │ $1,599.00   │
└─────────────┴─────────────┴─────────────┴─────────────┘
```

## 🚨 **SISTEMA DE ALERTAS**

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              🚨 SISTEMA DE ALERTAS                             │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────┬─────────────┬─────────────┬─────────────┬─────────────┬─────────────┐
│   USO %     │   ESTADO    │   COLOR     │   ACCIÓN    │   NOTIF.    │   BLOQUEO   │
├─────────────┼─────────────┼─────────────┼─────────────┼─────────────┼─────────────┤
│   0-79%     │   NORMAL    │   🟢 VERDE  │   NINGUNA   │   NINGUNA   │     NO      │
│   80-94%    │ ADVERTENCIA │   🟡 AMARILLO│  EMAIL      │   EMAIL     │     NO      │
│   95-99%    │   CRÍTICO   │   🟠 NARANJA│  EMAIL+SMS  │   EMAIL+SMS │     NO      │
│   100%+     │   BLOQUEADO │   🔴 ROJO   │  EMAIL+SMS  │   EMAIL+SMS │     SÍ      │
└─────────────┴─────────────┴─────────────┴─────────────┴─────────────┴─────────────┘

FLUJO DE ALERTAS:
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   📊 MONITOR│───▶│  🎯 DETECTAR│───▶│  📧 ENVIAR  │───▶│  📱 NOTIFICAR│
│   USO       │    │  UMBRAL     │    │  ALERTA     │    │  CLIENTE    │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
```

## 📊 **DASHBOARD DE MÉTRICAS**

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           📊 DASHBOARD DE MÉTRICAS                              │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  📈 RESUMEN MENSUAL                    │  🎯 USO POR SERVICIO                   │
│  ┌─────────────────────────────────┐   │  ┌─────────────────────────────────┐   │
│  │ 💰 Costo Total: $127.50        │   │  │ 📧 EMAIL: 8,500/10,000 (85%)   │   │
│  │ 📊 Servicios: 15,750           │   │  │ 💬 WHATSAPP: 3,200/5,000 (64%) │   │
│  │ 📅 Días restantes: 12          │   │  │ 📱 SMS: 1,800/2,000 (90%)      │   │
│  │ 🎯 Proyección: $180.00         │   │  │ 🔌 API: 45,000/100,000 (45%)   │   │
│  └─────────────────────────────────┘   │  └─────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  📊 GRÁFICO DE USO DIARIO          │  🚨 ALERTAS ACTIVAS                        │
│  ┌─────────────────────────────────┐ │  ┌─────────────────────────────────┐     │
│  │     📈                          │ │  │ ⚠️ SMS al 90% de límite        │     │
│  │ 1000│     ████                  │ │  │ 📧 Email al 85% de límite      │     │
│  │  800│  ████   ████              │ │  │ ✅ WhatsApp normal (64%)       │     │
│  │  600│███       ████             │ │  │ ✅ API normal (45%)            │     │
│  │  400│█           ████           │ │  └─────────────────────────────────┘     │
│  │  200│█             ████         │ │                                         │
│  │    0└───────────────────────────┘ │                                         │
│  │     1  3  5  7  9 11 13 15 17   │ │                                         │
│  └─────────────────────────────────┘ │                                         │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 🔧 **INTEGRACIÓN TÉCNICA**

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            🔧 INTEGRACIÓN TÉCNICA                               │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   📱 CLIENTE│───▶│  🔌 API     │───▶│  📊 TRACKER │───▶│  🗄️ DATABASE│
│   APP       │    │  GATEWAY    │    │  SERVICE    │    │  LAYER      │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
       │                   │                   │                   │
       │                   │                   │                   │
       ▼                   ▼                   ▼                   ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   📧 EMAIL  │    │  🔐 AUTH    │    │  🎯 LIMITS  │    │  📈 REPORTS │
│   SERVICE   │    │  JWT TOKEN  │    │  CONTROL    │    │  GENERATOR  │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
       │                   │                   │                   │
       │                   │                   │                   │
       ▼                   ▼                   ▼                   ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  💬 WHATSAPP│    │  🛡️ RATE    │    │  🚨 ALERTS  │    │  💰 BILLING │
│   SERVICE   │    │  LIMITING   │    │  SYSTEM     │    │  SYSTEM     │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
```

## 📋 **PLANES DE PRECIOS**

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              💰 PLANES DE PRECIOS                               │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────┬─────────────┬─────────────┬─────────────┬─────────────┬─────────────┐
│   PLAN      │   PRECIO    │   EMAIL     │  WHATSAPP   │    SMS      │   API CALLS │
│             │   MENSUAL   │   LÍMITE    │   LÍMITE    │   LÍMITE    │   LÍMITE    │
├─────────────┼─────────────┼─────────────┼─────────────┼─────────────┼─────────────┤
│ 🟢 BÁSICO   │   $29.00    │  10,000     │   5,000     │   2,000     │  100,000    │
│ 🟡 PROFES.  │   $79.00    │  50,000     │  25,000     │  10,000     │  500,000    │
│ 🔴 EMPRES.  │  $199.00    │ 200,000     │ 100,000     │  50,000     │2,000,000    │
│ ⚡ CUSTOM    │  NEGOCIABLE │  ILIMITADO  │  ILIMITADO  │  ILIMITADO  │  ILIMITADO  │
└─────────────┴─────────────┴─────────────┴─────────────┴─────────────┴─────────────┘

CARACTERÍSTICAS ADICIONALES:
┌─────────────┬─────────────┬─────────────┬─────────────┐
│   PLAN      │   SOPORTE   │   REPORTES  │   ALERTAS   │
├─────────────┼─────────────┼─────────────┼─────────────┤
│ 🟢 BÁSICO   │   EMAIL     │   BÁSICOS   │   EMAIL     │
│ 🟡 PROFES.  │ EMAIL+CHAT  │  AVANZADOS  │ EMAIL+SMS   │
│ 🔴 EMPRES.  │   24/7      │  PREMIUM    │ EMAIL+SMS   │
│ ⚡ CUSTOM    │ DEDICADO    │ PERSONALIZ. │ PERSONALIZ. │
└─────────────┴─────────────┴─────────────┴─────────────┘
```

---

**Este sistema proporciona control total sobre el uso y costos de servicios, con alertas proactivas y reportes detallados para optimizar el gasto y prevenir sobrecostos.**
