# üí¨ Chat y WhatsApp - Gu√≠a Completa

**Automatiza mensajer√≠a y crea chatbots inteligentes con nuestra API**

---

## üéØ **¬øQu√© puedes hacer con Chat y WhatsApp?**

### **Mensajer√≠a Autom√°tica**
- ‚úÖ **Env√≠o masivo** de mensajes personalizados
- ‚úÖ **Plantillas aprobadas** por WhatsApp Business
- ‚úÖ **Respuestas autom√°ticas** basadas en palabras clave
- ‚úÖ **Seguimiento de entregas** y estados de lectura

### **Chatbots Inteligentes**
- ‚úÖ **Respuestas contextuales** seg√∫n el tipo de evento
- ‚úÖ **Integraci√≥n con CRM** para personalizar mensajes
- ‚úÖ **Gesti√≥n de flujos** conversacionales complejos
- ‚úÖ **Escalamiento a humanos** cuando sea necesario

---

## üì± **Configuraci√≥n de WhatsApp**

### **Requisitos Previos**
1. **Cuenta WhatsApp Business API** activa
2. **N√∫mero de tel√©fono** verificado
3. **Plantillas aprobadas** por WhatsApp
4. **Token de acceso** a nuestra API

### **Verificar Conexi√≥n**
```javascript
async function verificarWhatsApp() {
  const response = await fetch('https://api2.eventosorganizador.com/graphql', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${miToken}`,
      'Origin': 'https://tu-dominio.com'
    },
    body: JSON.stringify({
      query: `
        query {
          getWhatsAppStatus {
            success
            status {
              conectado
              numeroVerificado
              plantillasAprobadas
              mensajesEnviados
              ultimaActividad
            }
            errors
          }
        }
      `
    })
  });

  const data = await response.json();
  
  if (data.data.getWhatsAppStatus.success) {
    const status = data.data.getWhatsAppStatus.status;
    console.log('üì± Estado de WhatsApp:');
    console.log(`   Conectado: ${status.conectado ? '‚úÖ' : '‚ùå'}`);
    console.log(`   N√∫mero verificado: ${status.numeroVerificado ? '‚úÖ' : '‚ùå'}`);
    console.log(`   Plantillas aprobadas: ${status.plantillasAprobadas}`);
    console.log(`   Mensajes enviados: ${status.mensajesEnviados}`);
    return status;
  } else {
    console.log('‚ùå Error verificando WhatsApp:', data.data.getWhatsAppStatus.errors);
    return null;
  }
}
```

---

## üìù **Env√≠o de Mensajes**

### **Enviar Mensaje Simple**
```javascript
async function enviarMensajeWhatsApp(numero, mensaje) {
  const response = await fetch('https://api2.eventosorganizador.com/graphql', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${miToken}`,
      'Origin': 'https://tu-dominio.com'
    },
    body: JSON.stringify({
      query: `
        mutation SendWhatsAppMessage($input: SendWhatsAppMessageInput!) {
          sendWhatsAppMessage(input: $input) {
            success
            messageId
            status
            timestamp
            errors
          }
        }
      `,
      variables: {
        input: {
          numero: numero,
          mensaje: mensaje,
          tipo: "texto"
        }
      }
    })
  });

  const data = await response.json();
  
  if (data.data.sendWhatsAppMessage.success) {
    const resultado = data.data.sendWhatsAppMessage;
    console.log('‚úÖ Mensaje enviado exitosamente:');
    console.log(`   ID: ${resultado.messageId}`);
    console.log(`   Estado: ${resultado.status}`);
    console.log(`   Timestamp: ${resultado.timestamp}`);
    return resultado.messageId;
  } else {
    console.log('‚ùå Error enviando mensaje:', data.data.sendWhatsAppMessage.errors);
    return null;
  }
}

// Ejemplo de uso
await enviarMensajeWhatsApp("+34600123456", "¬°Hola! Te recordamos que tienes un evento pr√≥ximo.");
```

### **Enviar Mensaje con Plantilla**
```javascript
async function enviarMensajePlantilla(numero, plantilla, variables) {
  const response = await fetch('https://api2.eventosorganizador.com/graphql', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${miToken}`,
      'Origin': 'https://tu-dominio.com'
    },
    body: JSON.stringify({
      query: `
        mutation SendWhatsAppTemplate($input: SendWhatsAppTemplateInput!) {
          sendWhatsAppTemplate(input: $input) {
            success
            messageId
            status
            timestamp
            errors
          }
        }
      `,
      variables: {
        input: {
          numero: numero,
          plantilla: plantilla,
          variables: variables
        }
      }
    })
  });

  const data = await response.json();
  
  if (data.data.sendWhatsAppTemplate.success) {
    const resultado = data.data.sendWhatsAppTemplate;
    console.log('‚úÖ Plantilla enviada exitosamente:');
    console.log(`   ID: ${resultado.messageId}`);
    console.log(`   Estado: ${resultado.status}`);
    return resultado.messageId;
  } else {
    console.log('‚ùå Error enviando plantilla:', data.data.sendWhatsAppTemplate.errors);
    return null;
  }
}

// Ejemplo de uso
await enviarMensajePlantilla("+34600123456", "recordatorio_evento", {
  nombre: "Mar√≠a",
  nombre_evento: "Mi Boda Perfecta",
  fecha: "25 de Diciembre",
  hora: "18:00"
});
```

### **Enviar Mensaje con Multimedia**
```javascript
async function enviarMensajeMultimedia(numero, tipo, url, mensaje) {
  const response = await fetch('https://api2.eventosorganizador.com/graphql', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${miToken}`,
      'Origin': 'https://tu-dominio.com'
    },
    body: JSON.stringify({
      query: `
        mutation SendWhatsAppMedia($input: SendWhatsAppMediaInput!) {
          sendWhatsAppMedia(input: $input) {
            success
            messageId
            status
            timestamp
            errors
          }
        }
      `,
      variables: {
        input: {
          numero: numero,
          tipo: tipo,  // "imagen", "video", "documento", "audio"
          url: url,
          mensaje: mensaje
        }
      }
    })
  });

  const data = await response.json();
  
  if (data.data.sendWhatsAppMedia.success) {
    const resultado = data.data.sendWhatsAppMedia;
    console.log('‚úÖ Multimedia enviada exitosamente:');
    console.log(`   ID: ${resultado.messageId}`);
    console.log(`   Estado: ${resultado.status}`);
    return resultado.messageId;
  } else {
    console.log('‚ùå Error enviando multimedia:', data.data.sendWhatsAppMedia.errors);
    return null;
  }
}

// Ejemplos de uso
await enviarMensajeMultimedia("+34600123456", "imagen", "https://ejemplo.com/foto.jpg", "Aqu√≠ tienes la foto de tu evento");
await enviarMensajeMultimedia("+34600123456", "documento", "https://ejemplo.com/invitacion.pdf", "Tu invitaci√≥n personalizada");
```

---

## ü§ñ **Chatbots Inteligentes**

### **Crear Chatbot**
```javascript
async function crearChatbot() {
  const response = await fetch('https://api2.eventosorganizador.com/graphql', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${miToken}`,
      'Origin': 'https://tu-dominio.com'
    },
    body: JSON.stringify({
      query: `
        mutation CreateChatbot($input: CreateChatbotInput!) {
          createChatbot(input: $input) {
            success
            chatbot {
              id
              nombre
              descripcion
              estado
              flujos {
                id
                nombre
                palabrasClave
                respuesta
                accion
              }
              createdAt
            }
            errors
          }
        }
      `,
      variables: {
        input: {
          nombre: "Asistente de Bodas",
          descripcion: "Chatbot especializado en consultas sobre bodas y eventos",
          flujos: [
            {
              nombre: "Saludo",
              palabrasClave: ["hola", "buenos d√≠as", "buenas tardes"],
              respuesta: "¬°Hola! Soy tu asistente de bodas. ¬øEn qu√© puedo ayudarte?",
              accion: "continuar"
            },
            {
              nombre: "Consultar Precios",
              palabrasClave: ["precio", "costo", "cuanto cuesta"],
              respuesta: "Te ayudo con informaci√≥n sobre precios. ¬øQu√© tipo de evento est√°s planeando?",
              accion: "solicitar_datos"
            },
            {
              nombre: "Consultar Disponibilidad",
              palabrasClave: ["disponible", "fecha", "cuando"],
              respuesta: "Para consultar disponibilidad, necesito saber la fecha aproximada. ¬øQu√© fecha tienes en mente?",
              accion: "solicitar_fecha"
            }
          ]
        }
      }
    })
  });

  const data = await response.json();
  
  if (data.data.createChatbot.success) {
    const chatbot = data.data.createChatbot.chatbot;
    console.log('‚úÖ Chatbot creado exitosamente:');
    console.log(`   ID: ${chatbot.id}`);
    console.log(`   Nombre: ${chatbot.nombre}`);
    console.log(`   Flujos: ${chatbot.flujos.length}`);
    return chatbot.id;
  } else {
    console.log('‚ùå Error creando chatbot:', data.data.createChatbot.errors);
    return null;
  }
}
```

### **Procesar Mensaje de Chatbot**
```javascript
async function procesarMensajeChatbot(numero, mensaje, chatbotId) {
  const response = await fetch('https://api2.eventosorganizador.com/graphql', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${miToken}`,
      'Origin': 'https://tu-dominio.com'
    },
    body: JSON.stringify({
      query: `
        mutation ProcessChatbotMessage($input: ProcessChatbotMessageInput!) {
          processChatbotMessage(input: $input) {
            success
            respuesta {
              mensaje
              tipo
              accion
              datos
            }
            flujo {
              id
              nombre
              estado
            }
            errors
          }
        }
      `,
      variables: {
        input: {
          numero: numero,
          mensaje: mensaje,
          chatbotId: chatbotId
        }
      }
    })
  });

  const data = await response.json();
  
  if (data.data.processChatbotMessage.success) {
    const resultado = data.data.processChatbotMessage;
    console.log('ü§ñ Respuesta del chatbot:');
    console.log(`   Mensaje: ${resultado.respuesta.mensaje}`);
    console.log(`   Acci√≥n: ${resultado.respuesta.accion}`);
    console.log(`   Flujo: ${resultado.flujo.nombre}`);
    
    // Enviar respuesta autom√°ticamente
    if (resultado.respuesta.mensaje) {
      await enviarMensajeWhatsApp(numero, resultado.respuesta.mensaje);
    }
    
    return resultado;
  } else {
    console.log('‚ùå Error procesando mensaje:', data.data.processChatbotMessage.errors);
    return null;
  }
}
```

---

## üìä **Campa√±as de WhatsApp**

### **Crear Campa√±a Masiva**
```javascript
async function crearCampanaWhatsAppMasiva() {
  const response = await fetch('https://api2.eventosorganizador.com/graphql', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${miToken}`,
      'Origin': 'https://tu-dominio.com'
    },
    body: JSON.stringify({
      query: `
        mutation CreateWhatsAppCampaign($input: CreateWhatsAppCampaignInput!) {
          createWhatsAppCampaign(input: $input) {
            success
            campaign {
              id
              nombre
              mensaje
              plantilla
              destinatarios {
                total
                segmentos
              }
              programacion {
                fechaEnvio
                horaEnvio
                zonaHoraria
              }
              estado
            }
            errors
          }
        }
      `,
      variables: {
        input: {
          nombre: "Promoci√≥n Navidad 2025",
          mensaje: "¬°Feliz Navidad! {{nombre}}, tenemos ofertas especiales para tu evento. ¬øTe interesa?",
          plantilla: "promocion_navidad",
          segmentos: ["clientes_activos", "leads_calificados"],
          programacion: {
            fechaEnvio: "2025-12-24",
            horaEnvio: "10:00",
            zonaHoraria: "Europe/Madrid"
          }
        }
      }
    })
  });

  const data = await response.json();
  
  if (data.data.createWhatsAppCampaign.success) {
    const campa√±a = data.data.createWhatsAppCampaign.campaign;
    console.log('‚úÖ Campa√±a de WhatsApp creada exitosamente:');
    console.log(`   ID: ${campa√±a.id}`);
    console.log(`   Nombre: ${campa√±a.nombre}`);
    console.log(`   Destinatarios: ${campa√±a.destinatarios.total}`);
    console.log(`   Fecha env√≠o: ${campa√±a.programacion.fechaEnvio}`);
    return campa√±a.id;
  } else {
    console.log('‚ùå Error creando campa√±a:', data.data.createWhatsAppCampaign.errors);
    return null;
  }
}
```

### **Ejecutar Campa√±a**
```javascript
async function ejecutarCampanaWhatsApp(campanaId) {
  const response = await fetch('https://api2.eventosorganizador.com/graphql', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${miToken}`,
      'Origin': 'https://tu-dominio.com'
    },
    body: JSON.stringify({
      query: `
        mutation ExecuteWhatsAppCampaign($campanaId: ID!) {
          executeWhatsAppCampaign(campanaId: $campanaId) {
            success
            resultado {
              mensajesEnviados
              mensajesEntregados
              mensajesFallidos
              tiempoEjecucion
            }
            errors
          }
        }
      `,
      variables: {
        campanaId: campanaId
      }
    })
  });

  const data = await response.json();
  
  if (data.data.executeWhatsAppCampaign.success) {
    const resultado = data.data.executeWhatsAppCampaign.resultado;
    console.log('‚úÖ Campa√±a ejecutada exitosamente:');
    console.log(`   Mensajes enviados: ${resultado.mensajesEnviados}`);
    console.log(`   Mensajes entregados: ${resultado.mensajesEntregados}`);
    console.log(`   Mensajes fallidos: ${resultado.mensajesFallidos}`);
    console.log(`   Tiempo ejecuci√≥n: ${resultado.tiempoEjecucion}s`);
    return resultado;
  } else {
    console.log('‚ùå Error ejecutando campa√±a:', data.data.executeWhatsAppCampaign.errors);
    return null;
  }
}
```

---

## üìà **Estad√≠sticas y Monitoreo**

### **Obtener Estad√≠sticas de WhatsApp**
```javascript
async function obtenerEstadisticasWhatsApp() {
  const response = await fetch('https://api2.eventosorganizador.com/graphql', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${miToken}`,
      'Origin': 'https://tu-dominio.com'
    },
    body: JSON.stringify({
      query: `
        query GetWhatsAppStats {
          getWhatsAppStats {
            success
            stats {
              mensajesEnviados
              mensajesEntregados
              mensajesLeidos
              mensajesFallidos
              porcentajeEntrega
              porcentajeLectura
              tiempoPromedioEntrega
              conversacionesActivas
              chatbotInteracciones
            }
            errors
          }
        }
      `
    })
  });

  const data = await response.json();
  
  if (data.data.getWhatsAppStats.success) {
    const stats = data.data.getWhatsAppStats.stats;
    console.log('üìä Estad√≠sticas de WhatsApp:');
    console.log(`   üì§ Mensajes enviados: ${stats.mensajesEnviados}`);
    console.log(`   ‚úÖ Mensajes entregados: ${stats.mensajesEntregados}`);
    console.log(`   üëÄ Mensajes le√≠dos: ${stats.mensajesLeidos}`);
    console.log(`   ‚ùå Mensajes fallidos: ${stats.mensajesFallidos}`);
    console.log(`   üìà % Entrega: ${stats.porcentajeEntrega}%`);
    console.log(`   üìà % Lectura: ${stats.porcentajeLectura}%`);
    console.log(`   ‚è±Ô∏è Tiempo promedio entrega: ${stats.tiempoPromedioEntrega}s`);
    console.log(`   üí¨ Conversaciones activas: ${stats.conversacionesActivas}`);
    console.log(`   ü§ñ Interacciones chatbot: ${stats.chatbotInteracciones}`);
    return stats;
  } else {
    console.log('‚ùå Error obteniendo estad√≠sticas:', data.data.getWhatsAppStats.errors);
    return null;
  }
}
```

### **Obtener Historial de Mensajes**
```javascript
async function obtenerHistorialMensajes(numero, limite = 10) {
  const response = await fetch('https://api2.eventosorganizador.com/graphql', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${miToken}`,
      'Origin': 'https://tu-dominio.com'
    },
    body: JSON.stringify({
      query: `
        query GetMessageHistory($numero: String!, $limite: Int!) {
          getMessageHistory(numero: $numero, limite: $limite) {
            success
            mensajes {
              id
              contenido
              tipo
              direccion
              timestamp
              estado
            }
            totalCount
            errors
          }
        }
      `,
      variables: {
        numero: numero,
        limite: limite
      }
    })
  });

  const data = await response.json();
  
  if (data.data.getMessageHistory.success) {
    const mensajes = data.data.getMessageHistory.mensajes;
    console.log(`üí¨ Historial de mensajes con ${numero}:`);
    mensajes.forEach(mensaje => {
      const direccion = mensaje.direccion === 'saliente' ? 'üì§' : 'üì•';
      const estado = mensaje.estado === 'entregado' ? '‚úÖ' : 
                    mensaje.estado === 'leido' ? 'üëÄ' : '‚è≥';
      console.log(`   ${direccion} ${mensaje.timestamp}: ${mensaje.contenido} ${estado}`);
    });
    return mensajes;
  } else {
    console.log('‚ùå Error obteniendo historial:', data.data.getMessageHistory.errors);
    return [];
  }
}
```

---

## üéØ **Ejemplo Completo: Sistema de Chat Automatizado**

```javascript
async function sistemaChatAutomatizado() {
  console.log('ü§ñ Iniciando sistema de chat automatizado...');
  
  try {
    // 1. Verificar conexi√≥n WhatsApp
    console.log('1Ô∏è‚É£ Verificando conexi√≥n WhatsApp...');
    const status = await verificarWhatsApp();
    if (!status || !status.conectado) {
      throw new Error('WhatsApp no est√° conectado');
    }
    
    // 2. Crear chatbot
    console.log('2Ô∏è‚É£ Creando chatbot...');
    const chatbotId = await crearChatbot();
    if (!chatbotId) throw new Error('No se pudo crear el chatbot');
    
    // 3. Crear campa√±a promocional
    console.log('3Ô∏è‚É£ Creando campa√±a promocional...');
    const campa√±aId = await crearCampanaWhatsAppMasiva();
    if (!campa√±aId) throw new Error('No se pudo crear la campa√±a');
    
    // 4. Ejecutar campa√±a
    console.log('4Ô∏è‚É£ Ejecutando campa√±a...');
    const resultado = await ejecutarCampanaWhatsApp(campa√±aId);
    
    // 5. Simular conversaciones con chatbot
    console.log('5Ô∏è‚É£ Simulando conversaciones...');
    const numerosPrueba = ["+34600123456", "+34600789012"];
    
    for (const numero of numerosPrueba) {
      console.log(`   Procesando mensaje de ${numero}...`);
      await procesarMensajeChatbot(numero, "hola", chatbotId);
      await new Promise(resolve => setTimeout(resolve, 1000)); // Pausa 1 segundo
      await procesarMensajeChatbot(numero, "precio", chatbotId);
    }
    
    // 6. Obtener estad√≠sticas finales
    console.log('6Ô∏è‚É£ Obteniendo estad√≠sticas finales...');
    const stats = await obtenerEstadisticasWhatsApp();
    
    console.log('üéâ ¬°Sistema de chat automatizado funcionando!');
    console.log(`   Chatbot ID: ${chatbotId}`);
    console.log(`   Campa√±a ID: ${campa√±aId}`);
    console.log(`   Mensajes enviados: ${resultado.mensajesEnviados}`);
    console.log(`   Conversaciones activas: ${stats.conversacionesActivas}`);
    
    return {
      chatbot: chatbotId,
      campa√±a: campa√±aId,
      mensajes: resultado.mensajesEnviados,
      stats: stats
    };
    
  } catch (error) {
    console.error('‚ùå Error en sistema automatizado:', error.message);
    return null;
  }
}

// Ejecutar sistema completo
const resultado = await sistemaChatAutomatizado();
```

---

## üéØ **Pr√≥ximos Pasos**

### **¬øYa dominas Chat y WhatsApp?**
üëâ **[Ir a Integraci√≥n con IA](./ai-integration.md)**

### **¬øQuieres ver ejemplos avanzados?**
üëâ **[Ir a API Avanzada](./advanced-api.md)**

### **¬øNecesitas personalizaci√≥n?**
üëâ **[Ir a Personalizaci√≥n](./customization.md)**

---

## üí° **Consejos para Chat y WhatsApp**

1. **Respeta los l√≠mites:** WhatsApp tiene l√≠mites de velocidad de env√≠o
2. **Usa plantillas aprobadas:** Evita que tus mensajes sean bloqueados
3. **Personaliza mensajes:** Usa variables para mayor impacto
4. **Monitorea entregas:** Revisa estad√≠sticas regularmente
5. **Escala a humanos:** Ten un proceso para casos complejos

---

**¬øNecesitas ayuda con Chat y WhatsApp?** üìß soporte@eventosorganizador.com
